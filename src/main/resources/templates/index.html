<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Real-time Chart</title>
</head>
<body>
<div>
    <canvas id="humiChart"></canvas>
</div>
<div>
    <canvas id="tempChart"></canvas>
</div>
<div>
    <canvas id="motiChart"></canvas>
</div>
<div>
    <canvas id="vibraChart"></canvas>
</div>
<div>
    <canvas id="fireChart"></canvas>
</div>

<script src="
https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js
"></script>
<script src="
https://cdn.jsdelivr.net/npm/stomp-websocket@2.3.4-next/lib/stomp.min.js
"></script>
<script src="
https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js
"></script>

<script th:inline="javascript">
    var stompClient = null;
    var ctxHumidity = document.getElementById('humiChart').getContext('2d');
    var ctxTemperature = document.getElementById('tempChart').getContext('2d');
    var ctxMotion = document.getElementById('motiChart').getContext('2d');
    var ctxVibrator = document.getElementById('vibraChart').getContext('2d');
    var ctxFire = document.getElementById('fireChart').getContext('2d');
    var charts = {};
    var topics = ['humiajat', 'tempajat', 'motiajat', 'vibrajat', 'fireajat'];

    topics.forEach(function (topic) {
        charts[topic] = createChart(topic);
    });

    function createChart(topic) {
        var config = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: topic,
                    backgroundColor: 'rgba(' + getRandomColor() + ', 0.2)',
                    borderColor: 'rgba(' + getRandomColor() + ', 1)',
                    borderWidth: 1,
                    data: []
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        return new Chart(getContextByTopic(topic), config);
    }

    function getContextByTopic(topic) {
        switch (topic) {
            case 'humiajat':
                return ctxHumidity;
            case 'tempajat':
                return ctxTemperature;
            case 'motiajat':
                return ctxMotion;
            case 'vibrajat':
                return ctxVibrator;
            case 'fireajat':
                return ctxFire;
            default:
                // in case kalo ada topik nyasar
                console.error("Topik tidak diketahui: " + topic);
                return null;
        }
    }

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/topic/messages', function (message) {
                var data = JSON.parse(message.body);
                var topic = data.topic;

                if (!charts[topic]) {
                    console.error("Chart tidak ada untuk topik: " + topic);
                    return;
                }

                var chart = charts[topic];
                var dataset = chart.data.datasets[0];

                dataset.data.push(data.value);
                chart.data.labels.push(data.timestamp);
                chart.update();
            });
        });
    }

    function getRandomColor() {
        return Math.floor(Math.random() * 256) + ',' +
            Math.floor(Math.random() * 256) + ',' +
            Math.floor(Math.random() * 256);
    }

    connect();
</script>

</body>
</html>
